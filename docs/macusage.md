# MAC usage

Usage of MAC is required in all ISO Message (Request and Response). See MAC details

## MAC details

The following principles shall be applied:

* All ISO messages are protected using a MAC.
* A new MAC key is generated for each ISO Message.
* The MAC key is protected using an Encryption key (Key Interchange)
* Key Interchange Keys will be exchanged between each party encrypted under a ZMK
* The ZMK (Zone Master Key) are exchanged during a key ceremony and imported into HSM.

### Message transformations

The transformation is applied to the message and the output from the transformation is input to the MAC algorithm. The
following transformations are supported:

* SHA1
* SHA-256
* None

### MAC algorithms

The following algorithms are supported:

* ISO 9797 algorithm 3 (3DES)
* CMAC (AES)

### MAC key protection alternatives

Currently there is support for 5 key interchange alternatives

* 2KeyTDES ECB no-padding
* 3KeyTDES ECB no-padding

* AES-128 (TR-31)
* AES-192 (TR-31)
* AES-256 (TR-31)

## Key Interchange

KI (Key Interchange) is the encrypted key used to encrypt the ephemeral MAC Key
KI shall be exchanged between the parties during the setup phase.
KI are exchanged encrypted under ZMK and shall be protected by HSM.
KI is identified by a key index (1 to 255) and allow Key Interchange switchover (key renewal)
Key index is present in ISO Message in field 48, subfield 001.

When using 3DES keys, the KI and ZMK must be 3DES keys of equal or better strength
When using AES keys, the KI and ZMK must be AES keys of equal or better strength

## MAC key

A MAC key shall be present in each ISO message, encrypted under KI in (Identifier "002", the MAC key)
The MAC key is an ephemeral key to be generated by each party and could be reused in several ISO Messages.
The maximum lifetime recommendation for an ephemeral MAC key is 1 hour.

## MAC

MAC shall be computed for each ISO Message.
MAC is present in Field n° 64 – Message Authentication Code
Input data of the MAC is SHA-256 hash of the full ISO payload encoded to bytes excluding the mac value field (Field 64).
Note: SHA-256 hash is used by default. SHA-1 hash can be used under request.

## Keys type and algorithms – 3DES

|                  |                                                                                                                                                                                                                                                |
|------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| KI Key Type      | "3 key" 3DES (size 24 bytes) or "2 key" 3DES (size 16 bytes) (*)                                                                                                                                                                               |
| MAC Key Type     | "2 key" 3DES (size 16 bytes)                                                                                                                                                                                                                   |
| MAC Key wrapping | 3DES using ECB                                                                                                                                                                                                                           |
| MAC              | MAC Algorithm 3 (ISO 9797-1 Algorithm 3). Padding method 1 is used: input data is completed with `0`s until the data reaches a multiple of 8-byte blocks. No `0` is added if already a multiple. The MAC is the 8 leftmost bytes of the output. |

(*) KI Key length depends to remote Host capability

## Keys type and algorithms – AES

|                  |                                                                                                                                     |
|------------------|-------------------------------------------------------------------------------------------------------------------------------------|
| KI Key Type      | AES (128, 192 or 256 bits)                                                                                                          |
| MAC Key Type     | 	AES 128, 192 or 256 bits                                                                                                           |
| MAC Key wrapping | 	AES TR-31                                                                                                                          |
| MAC	             | AES-CMAC Algorithm (RFC 4493), with padding as defined in the AES-CMAC specification The MAC is the 8 leftmost bytes of the output. |

