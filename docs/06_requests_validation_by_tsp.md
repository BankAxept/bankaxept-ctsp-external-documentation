# Requests validation by TSP

TSP performs a number of verifications on reception of 1100 and 1120 request messages using
information available at TSP level.

## TSP Database

When processing a message request, the TSP is using as a database either

* Token Information stored in the token vault or
* Transaction History File that log information related to transactions previously detokenized in last 18 months.

The retrieval of transaction in the Transaction History File is performed using an index composed of ‚ÄòRetrieval
reference number + Transaction Date and Time‚Äô corresponding to the concatenation of the field 37 value and field 07
value present in the origin transaction.

The type of ‚Äúdatabase‚Äù used by the TSP is depending on the type of request message.

## 1100 ‚ÄìDetokenization request to the Cloud TSP

The TSP is capable to process two types of de-tokenization request:

* Type 1 ‚Äì Detokenization request related to a new transaction: the detokenization has to be performed based on token
  vault data.
* Type 2 - Detokenization request related to a transaction already performed: the detokenization is based on TSP
  Transaction History File.

For ‚Äútype 1‚Äù transactions, the Processing Code (field 03) Position 1-2 always equal to ‚Äú00‚Äù (purchase)

The ‚Äútype 2‚Äù transactions are the transactions with Processing Code (field 03) Position 1-2 equals to one of the
following values

* 20: Refunds
* 22: Credit reversal
* 52: Credit ‚Äì return of goods
* 92: Confirmation of a pre-authorization

Note 1: With these 4 types of transaction, the presence of field 55 in the detokenization request message is optional
when the transaction is a chip transaction.
Note 2: 1100 is optional for these use cases. The 1120 message (Advise) can be sent without 1100 if detokenization,
meaning PAN knowledge, is not required.

### 1120 - Transaction Advice communication to the Cloud TSP (re-tokenization)

The TSP looks up a detokenization request in TSP Transaction History File by using TDT+RRN value as transaction ID. The
token tied to the transaction ID is used to look up PAN in token vault. TSP checks PAN in token vault matches PAN in
1120 ‚Äì Advice Message else an error is returned in Advice response

## Verification on 1100 ‚ÄìDetokenization request to the Cloud TSP

### HCE verification flow

**Note**: this flow applies to any digital wallet that is based on host-card-emulation (HCE) framework and applies
software security measures such as single-use-key. Such wallets include Samsung Pay, Google Pay, and proprietary HCE
wallets.

|         | TSP Check                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | Field (02,14,35) | Field 39 value |
|---------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------|----------------|
| **1**   | **General Message Structure checks**                                                                                                                                                                                                                                                                                                                                                                                                                                              |                  |                |
| 1.1     | Authorize client (mutual TLS / IP whitelist)                                                                                                                                                                                                                                                                                                                                                                                                                                      | No message body  |                |
| 1.2     | Well formed HTTP request (mandatory HTTP headers...)                                                                                                                                                                                                                                                                                                                                                                                                                              | No message body  |                |
| 1.3     | Validate header                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | No message body  |                |
| 1.4     | Parse ISO request                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | No message body  |                |
| 1.5     | Validate processing code                                                                                                                                                                                                                                                                                                                                                                                                                                                          | No message body  |                |
| 1.6     | Find correct handler by MTI and processing code (error if not match is found)                                                                                                                                                                                                                                                                                                                                                                                                     | No message body  |                |
| **2**   | **1100 Message checks**                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                  |                |
| 2.1     | Parse 1100 message                                                                                                                                                                                                                                                                                                                                                                                                                                                                | No message body  |                |
| 2.2     | Validate 1100 message                                                                                                                                                                                                                                                                                                                                                                                                                                                             | As request value | 006            |
| 2.3     | Verify MAC                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | No message body  |                |
| **3.1** | **Message processing ‚Äì Token value check**                                                                                                                                                                                                                                                                                                                                                                                                                                        |                  |                |
| 3.1.1   | Is VC known for given DPAN in token vault                                                                                                                                                                                                                                                                                                                                                                                                                                         | As request value | 003            |
| 3.1.2   | Is requestor authorized to access DPAN                                                                                                                                                                                                                                                                                                                                                                                                                                            | As request value | 003            |
| 3.1.3   | Validate issuer, VC and card (status is active)                                                                                                                                                                                                                                                                                                                                                                                                                                   | As request value | 003            |
| 3.1.4   | Validate that VC and card has not expired                                                                                                                                                                                                                                                                                                                                                                                                                                         | As request value | 001            |
| **3.2** | **Message processing ‚Äì PURE transaction Data validation**                                                                                                                                                                                                                                                                                                                                                                                                                         |                  |                |
| 3.2.1   | Validate format and version of field 55                                                                                                                                                                                                                                                                                                                                                                                                                                           | PAN or Req (*)   | 015            |
| 3.2.2   | Validate ATC is not outside the ATC window <br/><br/>Check:<br/> * IF (TCC presence in DE48 AND equals to X) AND (MCC in DE18 is one of the values in 7.6), THEN Apply ATC negative window * Check ATC within the overall window (either positive or negative) that means check IF: Previous value + ATC negative window < ATC < Previous value + ATC window. ELSE, Check ATC within the positive window that means check IF: Previous value < ATC < Previous  value + ATC window | PAN or Req (*)   | 030            |
| 3.2.3   | Validate SUK key is associated to key index defined in Issuer Application Data.                                                                                                                                                                                                                                                                                                                                                                                                   | PAN or Req (*)   | 014            |
| 3.2.4   | Validate ARQC cryptogram                                                                                                                                                                                                                                                                                                                                                                                                                                                          | PAN or Req (*)   | 005            |
| 3.2.5   | Optional, for QR code only: Validate ARQC validity period                                                                                                                                                                                                                                                                                                                                                                                                                         | PAN or Req (*)   | 016            |
| 3.2.6   | Validate if CDCVM cryptogram should be present: Verify that when CVR[2][8-6] = ‚Äò100‚Äô (or IAD[5][8-6]), CDCVM Stamp is different from 0000000000000000                                                                                                                                                                                                                                                                                                                             | PAN or Req (*)   | 020            |
| 3.2.7   | Check CDCVM cryptogram when CDCVM Stamp is different from 0000000000000000 and when CVR[2][8-6] = ‚Äò100‚Äô (or IAD[5][8-6])                                                                                                                                                                                                                                                                                                                                                          | PAN or Req (*)   | 021            |
| 3.2.8   | Validate that Cloud PIN stamp is not used (not supported in current version): when CVR[2][8-6] = ‚Äò011‚Äô (or IAD[5][8-6])                                                                                                                                                                                                                                                                                                                                                           | PAN or Req (*)   | 029            |
| 3.2.9   | Reserved For Future use (not implemented) Validate if Cloud PIN stamp should be present                                                                                                                                                                                                                                                                                                                                                                                           | PAN or Req (*)   | 024            |
| 3.2.10  | Reserved For Future use (not implemented) Check Cloud PIN stamp                                                                                                                                                                                                                                                                                                                                                                                                                   | PAN or Req (*)   | 024            |
|         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                  |                |
| 3.2.11  | Message verified OK                                                                                                                                                                                                                                                                                                                                                                                                                                                               | PAN              | 000            |

### Secure Element-based verification flow

|         | TSP Check                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Field (02,14,35) | Field 39 value |
|---------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------|----------------|
| **1**   | **General Message Structure checks**                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                  |                |
|         | Same as for 6.2.1                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                  |                |
| **2**   | **1100 Message checks**                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                  |                |
|         | Same as for 6.2.1                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                  |                |
| **3.1** | **Message processing ‚Äì Token value check**                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                  |                |
|         | Same as for 6.2.1                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                  |                |
| **3.2** | **Message processing ‚Äì Apple Pay Applet transaction Data validation**                                                                                                                                                                                                                                                                                                                                                                                                                      |                  |                |
| 3.2.1   | Validate format and version of field 55                                                                                                                                                                                                                                                                                                                                                                                                                                                    | PAN or Req (*)   | 015            |
| 3.2.2   | Validate ATC is not outside the ATC window <br/> Check: <br/> * IF (TCC presence in DE48 AND equals to X) AND (MCC in DE18 is one of the values in 7.6), THEN ** Apply ATC negative window *** Check ATC within the overall window (either positive or negative) that means check IF: Previous value + ATC negative window < ATC < Previous value + ATC window. <br/> ‚Ä¢ ELSE, Check ATC within the positive window that means check IF: Previous value < ATC < Previous value + ATC window | PAN or Req (*)   | 030            |
| 3.2.3   | Validate the key is associated to key index defined in Issuer Application Data.                                                                                                                                                                                                                                                                                                                                                                                                            | PAN or Req (*)   | 014            |
| 3.2.4   | Validate ARQC cryptogram                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | PAN or Req (*)   | 005            |
|         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                  |                |
| 3.2.6   | Message verified OK                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | PAN              | 000            |

(*) A TSP configuration parameter allows the support of two distinct rules related to the management of the field (02,
14, 35) value present in the response message.

* Option 1: The field (02, 14, 35) are using PAN value (result of the detokenization) only when all the TSP checks are
  passed (TSP action/response code equal to 000). In case of check failure (TSP action/response code different from
  000), the TSP echoes the value communicated in the request message.
* Option 2: The field (02, 14, 35) are using PAN value as soon as the detokenization process is successful. Therefore
  the field (02, 14, 35) are using PAN value even if one of the Token Domain Restriction checks (ei. field 55
  validation) fails (TSP action/response code not equal to one of the following values {001, 003, 006}).

This behavior (option 1 or option 2) is configurable per customer (domestic scheme or any closed loop environment).

### In-app payment cloud cryptogram verification flow

The in-app payment cloud cryptograms is a functionality provided by Cloud TSP for PSD2 compliance. The overview of the
functionality and format of the cryptograms is described in (1).

This flow is enabled by a configuration per customer. For customers in which enabled, the identification of the
applicability of the flow is performed by Field 22, Sub-field 1 PAN Entry Mode being ¬¥08¬¥.

|         | TSP Check                                                                                                                                                                                                                                                                                                       | Field (02,14,35) | Field 39 value |
|---------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------|----------------|
| **1**   | **General Message Structure checks**                                                                                                                                                                                                                                                                            |                  |                |
|         | Same as for 6.2.1                                                                                                                                                                                                                                                                                               |                  |                |
| **2**   | **1100 Message checks**                                                                                                                                                                                                                                                                                         |                  |                |
|         | Same as for 6.2.1                                                                                                                                                                                                                                                                                               |                  |                |
| **3.1** | **Message processing ‚Äì Token value check**                                                                                                                                                                                                                                                                      |                  |                |
|         | Same as for 6.2.1                                                                                                                                                                                                                                                                                               |                  |                |
| **3.2** | **Message processing ‚Äì In-App payment cloud cryptogram transaction Data validation**                                                                                                                                                                                                                            |                  |                |
| 3.2.1   | Validate format and version of field 55                                                                                                                                                                                                                                                                         | PAN or Req (*)   | 015            |
| 3.2.2   | Validate format of cryptogram in tag C4                                                                                                                                                                                                                                                                         | PAN or Req (*)   | 015            |
| 3.2.3   | Validate Version (tag C5 of cryptogram in tag C4)                                                                                                                                                                                                                                                               | PAN or Req (*)   | 015            |
| 3.2.4   | Validate ATC (tag 9F36 of cryptogram in tag C4) is not outside the ATC window <br/> Check ATC within the positive window that means check IF: Previous value < ATC < Previous value + ATC window                                                                                                                | PAN or Req (*)   | 030            |
| 3.2.5   | Validate the LVR (tag C5 of cryptogram in tag C4) against allowed values                                                                                                                                                                                                                                        | PAN or Req (*)   | 019            |
| 3.2.6   | Validate ‚ÄúTransaction Currency Code‚Äù (tag 5F2A of cryptogram in tag C4)                                                                                                                                                                                                                                         | PAN or Req (*)   | 018            |
| 3.2.7   | Being: <br/> * amount_field, the ‚ÄúAmount, Authorised‚Äù in field 4; and <br/>  amount_crypto, the ‚ÄúAmount, Authorised‚Äù in tag 9F02 of cryptogram in tag C4 <br/> p, the percentage above the consented amount that will be allowed for authorisation br/> Verify that 0 ‚â§ amount_field ‚â§ (1 + ùëù) x amount_crypto | PAN or Req (*)   | 017            |
| 3.2.8   | Validate the key associated to DKI (tag C5 of cryptogram in tag C4)                                                                                                                                                                                                                                             | PAN or Req (*)   | 018            |
| 3.2.9   | Validate cryptographically the Authentication value (tag C5 of cryptogram in tag C4)                                                                                                                                                                                                                            | PAN or Req (*)   | 018            |
| 3.2.6   | Message verified OK                                                                                                                                                                                                                                                                                             | PAN              | 000            |

(*) A TSP configuration parameter allows the support of two distinct rules related to the management of the field (02,
14, 35) value present in the response message.

* Option 1: The field (02, 14, 35) are using PAN value (result of the detokenization) only when all the TSP checks are
  passed (TSP action/response code equal to 000). In case of check failure (TSP action/response code different from
  000), the TSP echoes the value communicated in the request message.

* Option 2: The field (02, 14, 35) are using PAN value as soon as the detokenization process is successful. Therefore
  the field (02, 14, 35) are using PAN value even if one of the Token Domain Restriction checks (ei. field 55
  validation) fails (TSP action/response code not equal to one of the following values {001, 003, 006}).

This behavior (option 1 or option 2) is configurable per customer (domestic scheme or any closed loop environment)

## Verification on 1120 - Transaction Advice communication to the Cloud TSP (re-tokenization)

|         | TSP Check                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Notification sent | Field (02,14,35) | Field 39 value |
|---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------|------------------|----------------|
| **1**   | **General Message Structure checks**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                   | No message body  |                |
| 1.1     | Authorize client (mutual TLS / IP whitelist)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | No                | No message body  |                |
| 1.2     | Well formed HTTP request (mandatory HTTP headers ...)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | No                | No message body  |                |
| 1.3     | Validate header                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | No                | No message body  |                |
| 1.4     | Parse ISO request                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | No                | No message body  |                |
| 1.5     | Validate processing code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | No                | No message body  |                |
| 1.6     | Find correct handler by MTI and processing code (error if not match is found)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | No                | No message body  |                |
| **2**   | **1120 Message checks**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                   |                  |                |
| 2.1     | Parse 1120 message                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | No                | No message body  |                |
| 2.2     | Validate 1120 message                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | No                | Request          | 006            |
| 2.3     | Check that field 39 value is in the range of values supported (see 6.12)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | No                | As request value | 006            |
| 2.4     | Validate MAC                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | No                | No message body  |                |
| **3**   | **Message processing**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                   |                  |                |
| 3       | Check if field 02 is a DPAN (Token) or a FPAN (physical card PAN)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                   |                  |                |
| **3.1** | **Field 02 = DPAN (Advice after failed detokenization)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                   |                  |                |
| 3.1.1   | Check that field 39 in advice 1120 message is not 000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | No                | Request          | 003            |
| 3.1.2   | Validate issuer                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | No                | Request          | 003            |
| 3.1.3   | Try to retrieve the original message in Transaction History File (by using RRN and TDT)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                   |                  |                |
| 3.1.4   | If message retrieved, validate that the response code in the original message is different from 000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | No                | Request          | 006            |
| 3.1.6   | Request the TSH to send a notification message to the mobile. The type of notification is dependeng on the Field 03 position 1-2 value: <br/> * First, it is not expected to receive value ¬¥20¬¥, ¬¥22¬¥ or ¬¥52¬¥ in Field 03 position 1-2, in this specific case <br/> * For all the other values of Field 03 position 1-2 value (values not equal to 20, 22 or 52), transactionType in the notification depends on the exact value of position 1 ‚Äì 2, and the mapping can be found in Section 7.2. <br/> For all cases, transactionResult =DECLINED                                                                                                                                                                                                                      | Yes               | DPAN             | 000            |
| **3.2** | **Field 02 = FPAN: Advice on payment after detokenization (transaction approved or transaction declined or transaction reversed)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                   |                  |                |
| 3.2.1   | Find original message in Transaction History File (by using RRN and TDT)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | No                | Request          | 003            |
| 3.2.2   | Validate issuer                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | No                | Request          | 003            |
| 3.2.2   | Is requestor authorized to access DPAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | No                | Request          | 003            |
| 3.2.4   | Request the TSH to send a notification message to the mobile. <br/> The values for transactionType and transactionResult follow: <br/> <table><th>Field 03 position 1-2</th><th>Field 39</th><th>Transaction Type</th><th>Transaction Result</th><tr><td>'00'</td><td>'00' <br/> not '00'</td><td>PURCHASE</td><td>APPROVED <br/> DECLINED</td></tr><tr><td>'20'</td><td>'00' <br/> not '00'</td><td>REFUND</td><td>APPROVED <br/> DECLINED</td></tr><tr><td>'22'</td><td>'00' <br/> not '00'</td><td>PURCHASE</td><td>APPROVED <br/> DECLINED</td></tr><tr><td>'52'</td><td>'00' <br/> not '00'</td><td>PURCHASE</td><td>APPROVED <br/> DECLINED</td></tr><tr><td>'92'</td><td>'00' <br/> not '00'</td><td>PURCHASE</td><td>APPROVED <br/> DECLINED</td></tr></table> | Yes               | DPAN             | 000            |
